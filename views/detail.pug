extends layout.pug

block content
        .container
                .jumbotron.text-center
                        h1.fa.fa-comments What a poll!
                .container.jumbotron
                        h2 #{poll.title}
                        .container.col-sm-6.well
                            form(id="votingpoll" name="voteforpoll" action="/poll/"+poll._id+"/answer" method="post")
                                .form-group
                                    .col-xs-6
                                        select(name="answerselected").form-control
                                          each answer in answers
                                            option(value=answer._id) #{answer.title}
                                div.text-center.col-xs-6
                                            button(type="submit").btn.btn-success.btn-lg Vote
                            a(href="https://twitter.com/intent/tweet?text=Go%20See%20This%20%Poll%20https://voting-app-project-benobab.c9users.io/poll/" + poll._id).btn.navbar-btn(type='button').twitter-share
                                i.fa.fa-twitter
                                |  Share it
                        .container.col-sm-6.well
                            p no result to display yet
                            canvas#mychart(width="400", height="400")
                script(type='text/javascript').
                    /*Function to update the chart*/
                    $(document).ready(function(){
                        /*To run this function when the page is loaded ;-)*/
                        window.onload = function() {
                          getDataset();
                        };
                        $('#shareOnTwitter').on('click', function(){
                            var pollUrl = window.location.href;
                            var text = "https://twitter.com/intent/tweet?text=Go%20See%20This%20%Poll%20https://voting-app-project-benobab.c9users.io/poll/" + poll._id;
                            window.location.href = text;
                        });
                        
                        var getDataset = function() {
                            var url = "/poll/"+"#{poll._id}"+"/dataset";
                            $.get(url, function( data ) {
                              updateChart(JSON.parse(data));
                            });
                        }
                        
                        var updateChart = function(data){
                        console.log(data);
                        var ctx = $('#mychart'); //The chart that is going to be updated
                        console.log(ctx);
                        console.log("I'll update the chart");
                        var myChart = new Chart(ctx, {
                            type: 'pie',
                            data: data
                        });
                    }
                        /*Function to vote*/
                    $('#votingpoll').submit(function(event) {
                        console.log("In the good func");
                            event.preventDefault(); // Stops browser from navigating away from page
                            var url = "/poll/"+"#{poll._id}"+"/answer";
                            $.post(url,$('#votingpoll').serialize(), function( data ) {
                              var datas = JSON.parse(data);
                              alert(datas.message);
                              if(datas.refresh){
                                getDataset();   
                              }
                            });
                        });
                    });
                    
        script(src='/js/Chart.js')